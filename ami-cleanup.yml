---
- name: Manage AWS AMI cleanup - Delete old and unused AMIs from AWS account
  gather_facts: false
  hosts:
    - localhost
  vars:
    delete_snapshots: 'True'
    inuse_amis: []
    older_amis: []
    ami_filter_age_days: '1 hour' # 30 day, 24 hour
  tasks:
    - name: Get the current caller identity information
      amazon.aws.aws_caller_info:
      register: caller_info

    - name: List AMIs in AWS account
      amazon.aws.ec2_ami_info:
        owners: "{{ caller_info.account }}"
      register: list_amis

    - set_fact:
        filter_date: "{{ lookup('pipe','date \"+%Y-%m-%d\" -d \"{{ ami_filter_age_days }} ago\"') }}"

    - set_fact:
       filtered_ami: "{{ list_amis | json_query(\"images[?creation_date<=`\" + filter_date + \"`]\") }}"

    - shell: echo "{{ filtered_ami | length }} {{ list_amis.images | length }}"

    - debug: var=filter_date

    - debug: msg="{{ item }}"
      with_items: "{{ list_amis.images }}"

    - name: List EC2 instances in AWS account
      community.aws.ec2_instance_info:
        filters:
          instance-state-name: ["running","pending"]
      register: list_ec2_instances

    - debug: msg="{{ item.image_id }}"
      with_items: "{{ list_ec2_instances.instances }}"

    - name: collect AMIs in use by EC2 instances
      set_fact:
        inuse_amis: "{{ inuse_amis + [ item.image_id ] }}"
      with_items: "{{ list_ec2_instances.instances }}"

    - name: collect old AMIs
      set_fact:
        older_amis: "{{ older_amis + [ item.image_id ] }}"
      with_items: "{{ filtered_ami }}"

    - debug: var=inuse_amis
    - debug: var=older_amis

    - name: Report Delete AMIs older then age and not in use
      debug:
        msg: "Skip deletion of AMI {{ item.image_id }} as it is currently in-use or not older then {{ ami_filter_age_days }}"
      with_items: "{{ list_amis.images }}"
      when:
        - item.image_id in inuse_amis
        - item.image_id in older_amis

    - name: Delete AMIs older then age and not in use
      amazon.aws.ec2_ami:
        image_id: "{{ item.image_id }}"
        delete_snapshot: "{{ delete_snapshots }}"
        state: absent
      with_items: "{{ list_amis.images }}"
      when:
        - item.image_id not in inuse_amis
        - item.image_id in older_amis
